<VirtualHost *:80>
    # <FilesMatch "\.php$"> → 실제 파일 이름이 .php일 때만 매칭
    # <LocationMatch "\.php$"> → 요청된 URL 경로가 .php로 끝날 때 매칭

    # <LocationMatch> : 클라이언트 요청 URL 경로를 정규식으로 매칭해서 동작
    # <LocationMatch "\.php$">
    #     SetHandler "proxy:fcgi://php:9000"
    # </LocationMatch>

    # 기본적으로 .php는 PHP-FPM으로 실행
    # <FilesMatch> : 파일 이름(특히 디스크상의 실제 파일 경로)에 정규 표현식을 이용해 표현식과 일치하는 파일에 대한 설정을 적용
    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://php:9000"
    </FilesMatch>

    ServerName localhost
    DocumentRoot "/var/www/html"

    # AllowEncodedSlashes On
    AllowEncodedSlashes NoDecode
    RewriteEngine On

    # Filename Confusion - Path Truncation
    RewriteRule "^/user/(.*)$" "/var/user/$1/profile.yml" [L]
    # Path Truncation 방어 : 화이트리스트 기반 RewriteRule 적용
    # RewriteRule "^/user/([a-zA-Z0-9_-]+)$" "/var/user/$1/profile.yml" [L]

    # Local Gadgets Manipulation
    # Prefix rewrite 예시
    RewriteRule "^/view/(.*)$" "/var/www/html/$1" [L]

    <Directory "/var/www/html">
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted

        # ACL Bypass 구현
        # secret.php는 개별 파일 보호
        <Files "secret.php">
            AuthType Basic
            AuthName "Restricted Area"
            AuthUserFile "/usr/local/apache2/.htpasswd"
            Require valid-user
        </Files>

    </Directory>

    # ACL Bypass 방어 : 파일 이름이 아닌 경로기반 접근 제어
    # <LocationMatch "^/secret\.php(\?.*)?$">
    #     AuthType Basic
    #     AuthName "Restricted Area"
    #     AuthUserFile "/usr/local/apache2/.htpasswd"
    #     Require valid-user
    # </LocationMatch>

    <Directory "/var/user">
        Options Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # Local Gadget to Information Disclosure
    # /usr/share 디렉토리 하위 디렉토리 밑 파일 전체를 노출
    Alias /usr/share "/usr/share"

    <Directory "/usr/share">
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
        # 방어 : 디렉토리 접근권한 제어
        # Require all denied

        # php는 실행
        <FilesMatch "\.php$">
            SetHandler "proxy:fcgi://php:9000"
        </FilesMatch>
    </Directory>

</VirtualHost>